<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>WoundAi</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" href="{{ url_for('static', filename='wound.png') }}" type="image/x-icon">
  <link rel="shortcut icon" href="{{ url_for('static', filename='wound.png') }}" type="image/x-icon">
  <link rel="icon" href="{{ url_for('static', filename='wound.png') }}" type="image/png" sizes="32x32">
  <link rel="stylesheet" href="/static/styles.css">
</head>
<body>

  <!-- Navigation Bar -->
  <nav class="navbar">
    <div class="navbar-logo">
      <a href="/">
        <img src="/static/wound.png" alt="WoundAI Logo" onerror="this.style.display='none'">
      </a>
    </div>
    <div class="navbar-links">
      <a href="/" class="nav-link active">Home</a>
      <a href="/about" class="nav-link">About</a>
      <a href="/contact" class="nav-link">Contact</a>
    </div>
  </nav>

  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
    <div class="loading-text">Analyzing image</div>
    <div class="progress-text" id="progressText"></div>
  </div>

  <!-- Zoom Backdrop -->
  <div class="zoom-backdrop" id="zoomBackdrop"></div>

  <!-- Toast Container -->
  <div class="toast-container" id="toastContainer"></div>

  <!-- Camera Modal -->
  <div class="camera-modal" id="cameraModal">
    <div class="camera-container">
      <video id="cameraVideo" autoplay playsinline></video>
      <canvas id="cameraCanvas"></canvas>
      <div class="camera-controls">
        <button class="camera-btn" id="captureBtn">Capture Photo</button>
        <button class="camera-btn" id="switchCameraBtn">Switch</button>
        <button class="camera-btn secondary" id="closeCameraBtn">Close</button>
      </div>
    </div>
  </div>

  <!-- Get Started Modal -->
  <div class="welcome-modal" id="welcomeModal">
    <div class="welcome-modal-content">
      <button class="modal-close-btn" id="closeModalBtn">‚úï</button>
      <div class="modal-header">
        <img src="/static/wound.png" alt="WoundAI Logo" class="modal-logo">
        <h2>Welcome to WoundAI</h2>
        <p class="modal-subtitle">Your AI-Powered Wound Analysis Assistant</p>
      </div>

      <div class="modal-body">
        <section class="modal-section">
          <h3>üìã About This Project</h3>
          <p>
            WoundAI is an advanced medical AI application that automatically detects, classifies, and provides treatment
            recommendations for different types of wounds. Powered by EfficientNetB1 deep learning model and Google's Gemini AI,
            we deliver accurate wound classification with explainable AI visualizations.
          </p>
        </section>

        <section class="modal-section">
          <h3>üéØ How to Use</h3>
          <ol>
            <li><strong>Upload an Image:</strong> Click "Choose File" or use the "Camera" button to capture a wound photo</li>
            <li><strong>Gemini Triage:</strong> The AI will automatically verify that your image contains an actual wound</li>
            <li><strong>Analyze:</strong> Click the "Analyze" button to start the wound classification process</li>
            <li><strong>Review Results:</strong> View the predicted wound type, confidence score, and Grad-CAM visualization</li>
            <li><strong>Read Recommendations:</strong> Get detailed treatment suggestions from Gemini LLM in Indonesian</li>
          </ol>
        </section>

        <section class="modal-section">
          <h3>‚ú® Expected Results</h3>
          <ul>
            <li><strong>Wound Classification:</strong> Identification of 10 wound types (Abrasions, Bruises, Burns, Cuts, Diabetic Wounds, Lacerations, Normal, Pressure Wounds, Surgical Wounds, Venous Wounds)</li>
            <li><strong>Confidence Score:</strong> Percentage indicating the model's certainty in its prediction</li>
            <li><strong>Grad-CAM Heatmap:</strong> Visual explanation showing which parts of the image influenced the AI's decision</li>
            <li><strong>Overlay Visualization:</strong> Heatmap overlaid on the original image for better context</li>
            <li><strong>Treatment Recommendations:</strong> Clinically-backed suggestions for wound care in Indonesian language</li>
          </ul>
        </section>

        <section class="modal-section modal-footer-section">
          <p><strong>Note:</strong> This tool is designed to assist healthcare professionals and should not replace professional medical advice.</p>
        </section>
      </div>
    </div>
  </div>

  <div class="main-grid">

    <div class="left-column">

      <div class="card" id="upload-box">
        <form method="POST" enctype="multipart/form-data" id="uploadForm" class="upload-controls">
          
          <div class="input-row">
            <label for="imageInput" class="file-label">üìÅ Choose File</label>
            <input type="file" name="image" id="imageInput" accept=".png,.jpg,.jpeg,.webp" required>
            
            <button type="button" class="icon-btn" id="cameraBtn">üì∑ Camera</button>
          </div>

          <div class="btn-group">
            <button class="btn" type="submit" id="analyzeBtn">Analyze</button>
            <a href="/" class="btn btn-new">New</a>
          </div>
          
          <div class="file-info-row">
            <div class="inline-spinner" id="inlineSpinner"></div>
            <span id="fileNameDisplay">No file selected</span>
            <span id="clearFile">‚ùå</span>
          </div>
        </form>

        <div id="imagePreview" class="preview-box">
          <span id="previewPlaceholder">PREVIEW IMAGE</span>
          <img id="previewImg" alt="Image preview">
        </div>
      </div>

      <div class="card" id="result-box">
        {% if result %}
          {% if result.status == "error" %}
            <div class="err">Model Load Error</div>
            <pre>{{ result.message }}</pre>
            <p class="muted">Re-export your Keras model with input=(224,224,3).</p>

          {% elif result.status == "not_wound" %}
            <div class="err">Bukan Gambar Luka</div>
            <p class="muted">Gemini triage indicates the uploaded image is not a wound/ulcer.</p>
            {% if result.input_image %}
              <div class="viz-container">
                <div class="viz-box">
                  <img src="{{ '/' + result.input_image }}" alt="uploaded">
                </div>
              </div>
            {% endif %}
          
          {% elif result.status == "ok" %}
            <div class="ok">Prediction completed</div>
            <p>
              <span class="label">Predicted Class:</span>
              <span class="pill">{{ result.pred_label }}</span>
            </p>
            <p>
              <span class="label">Confidence Score:</span> {{ result.confidence_pct }}%
            </p>
            <div class="confidence-bar">
              <div class="confidence-fill" style="width: {{ result.confidence_pct }}%;"></div>
            </div>
            
            <div class="viz-container">
              <div class="viz-box" id="gradcam-box">
                <img src="{{ '/' + result.heatmap_image }}" alt="heatmap">
              </div>
              <div class="viz-box" id="overlay-box">
                <img src="{{ '/' + result.overlay_image }}" alt="overlay">
              </div>
            </div>

          {% endif %}
        {% else %}
          <p style="color: #888; font-style: italic;">Upload an image and click "Analyze" to see results here...</p>
        {% endif %}
      </div>
    </div>

    <div class="right-column">
      
      <div class="card" id="gemini-box">
        <h3>Gemini LLM Analysis</h3>
        
        {% if result and result.status == "ok" %}
          <div class="gemini-content">
            {{ result.gemini_html | safe }}
          </div>
        {% else %}
          <div class="gemini-content" style="display:flex; align-items:center; justify-content:center; color:#888;">
            <p style="text-align:center; font-style:italic;">Hasil analisis dan penanganan dari Gemini LLM akan muncul di sini...</p>
          </div>
        {% endif %}
      </div>

    </div>
  </div>
  <script>
    // --- JavaScript for UI interactivity ---
    
    const imageInput = document.getElementById('imageInput');
    const cameraBtn = document.getElementById('cameraBtn');
    const imagePreview = document.getElementById('imagePreview');
    const previewImg = document.getElementById('previewImg');
    const previewPlaceholder = document.getElementById('previewPlaceholder');
    const fileNameDisplay = document.getElementById('fileNameDisplay');
    const clearFile = document.getElementById('clearFile');
    const inlineSpinner = document.getElementById('inlineSpinner');

    // Toast Notification System
    function showToast(type, title, message) {
      const toastContainer = document.getElementById('toastContainer');
      
      // Icon mapping
      const icons = {
        success: '‚úì',
        error: '‚úï',
        warning: '‚ö†',
        info: '‚Ñπ'
      };
      
      // Create toast element
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.innerHTML = `
        <div class="toast-icon">${icons[type] || '‚Ñπ'}</div>
        <div class="toast-content">
          <div class="toast-title">${title}</div>
          <div class="toast-message">${message}</div>
        </div>
        <button class="toast-close" onclick="this.parentElement.remove()">‚úï</button>
      `;
      
      toastContainer.appendChild(toast);
      
      // Auto remove after 3 seconds
      setTimeout(() => {
        if (toast.parentElement) {
          toast.remove();
        }
      }, 3000);
    }

  // Camera modal elements
  const cameraModal = document.getElementById('cameraModal');
  const cameraVideo = document.getElementById('cameraVideo');
  const cameraCanvas = document.getElementById('cameraCanvas');
  const captureBtn = document.getElementById('captureBtn');
  const closeCameraBtn = document.getElementById('closeCameraBtn');
  const switchCameraBtn = document.getElementById('switchCameraBtn');
  let cameraStream = null;
  let currentFacingMode = 'environment'; // default to rear on mobile

    // 1. Handle image preview and file name display
    function handleFileSelect(file) {
      if (file) {
        const reader = new FileReader();
        
        reader.onload = function(event) {
          previewImg.src = event.target.result;
          previewImg.style.display = 'block';
          previewPlaceholder.style.display = 'none';
        };
        
        reader.readAsDataURL(file);
        
        // Update file name display
        fileNameDisplay.textContent = file.name;
        fileNameDisplay.style.display = 'inline'; // Show file name
        clearFile.style.display = 'inline'; // Show clear button
      } else {
        resetPreview();
      }
    }

    imageInput.addEventListener('change', function(e) {
      const file = e.target.files[0];
      handleFileSelect(file);
      if (file) runTriage(file);
    });

    // 2. Camera button functionality - Open real camera
    cameraBtn.addEventListener('click', async function() {
      try {
        cameraModal.classList.add('active');
        await startCamera(currentFacingMode);
      } catch (err) {
        showToast('error', 'Camera Access Denied', 'Unable to access your camera. Please check your browser permissions and try again.');
        cameraModal.classList.remove('active');
      }
    });

    // Switch camera (front/back) on mobile devices
    switchCameraBtn.addEventListener('click', async function() {
      // Toggle facing mode
      currentFacingMode = (currentFacingMode === 'environment') ? 'user' : 'environment';
      try {
        await startCamera(currentFacingMode);
      } catch (err) {
        console.warn('Switch camera failed:', err);
      }
    });

    async function startCamera(facingMode) {
      // Stop any existing stream first
      if (cameraStream) {
        cameraStream.getTracks().forEach(track => track.stop());
        cameraStream = null;
      }

      // Try to get camera with facingMode constraint
      const constraints = {
        video: {
          facingMode: { exact: facingMode },
          width: { ideal: 1280 },
          height: { ideal: 720 }
        },
        audio: false
      };

      try {
        cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
      } catch (err) {
        // Some browsers/devices don't support exact facingMode; try a looser constraint
        try {
          cameraStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode }, audio: false });
        } catch (err2) {
          // Fallback to default camera
          cameraStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
        }
      }

      cameraVideo.srcObject = cameraStream;
      // Some browsers require play() call after srcObject set
      try { await cameraVideo.play(); } catch(e) { /* ignore */ }
    }

  // 3. Capture photo from camera
    captureBtn.addEventListener('click', function() {
      // Set canvas size to match video
      cameraCanvas.width = cameraVideo.videoWidth;
      cameraCanvas.height = cameraVideo.videoHeight;
      
      // Draw current video frame to canvas
      const ctx = cameraCanvas.getContext('2d');
      ctx.drawImage(cameraVideo, 0, 0);
      
      // Convert canvas to blob and create file
      cameraCanvas.toBlob(function(blob) {
        const file = new File([blob], `camera_${Date.now()}.jpg`, { type: 'image/jpeg' });
        
        // Transfer to main input
        const dataTransfer = new DataTransfer();
        dataTransfer.items.add(file);
        imageInput.files = dataTransfer.files;
        
        // Show preview
        handleFileSelect(file);
        // Run triage on captured image
        runTriage(file);
        // Close camera modal after capture
        stopCamera();
      }, 'image/jpeg', 0.95);
    });

    // 4. Close camera modal
    closeCameraBtn.addEventListener('click', function() {
      stopCamera();
    });

    // Stop camera stream
    function stopCamera() {
      if (cameraStream) {
        cameraStream.getTracks().forEach(track => track.stop());
        cameraStream = null;
      }
      cameraModal.classList.remove('active');
    }

    // 5. Handle the 'clear file' (X) button
    clearFile.addEventListener('click', function() {
      imageInput.value = null;
      resetPreview();
    });

    // 6. Reset helper function
    function resetPreview() {
      previewImg.src = '';
      previewImg.style.display = 'none';
      previewPlaceholder.style.display = 'block';
      fileNameDisplay.textContent = 'No file selected';
      fileNameDisplay.style.display = 'none'; // Hide file name
      clearFile.style.display = 'none'; // Hide clear button
      inlineSpinner.classList.remove('active'); // Hide spinner
    }

    // 7. Show inline loading spinner when form is submitted
    const uploadForm = document.getElementById('uploadForm');
    const loadingOverlay = document.getElementById('loadingOverlay');
    const analyzeBtn = document.getElementById('analyzeBtn');

    uploadForm.addEventListener('submit', async function(e) {
      e.preventDefault(); // Prevent default form submission

      // Show inline spinner next to file name
      inlineSpinner.classList.add('active');
      analyzeBtn.disabled = true;
      // Keep full screen overlay too for better UX
      loadingOverlay.classList.add('active');

      const file = imageInput.files[0];
      if (!file) return; // let server validate

      // If triage hasn't run yet, run it now synchronously before submitting
      if (uploadForm.dataset.triage !== 'true') {
        await runTriage(file);
      }

      // If triage failed (NOT_WOUND), cancel submit and show message
      if (uploadForm.dataset.triage === 'false') {
        loadingOverlay.classList.remove('active');
        inlineSpinner.classList.remove('active');
        analyzeBtn.disabled = false;
        showToast('error', 'Not a Wound Image', uploadForm.dataset.triage_msg || 'The uploaded image does not appear to be a wound. Please upload a valid wound image.');
        return;
      }

      // Start progress polling
      const progressText = document.getElementById('progressText');
      let progressInterval = setInterval(async () => {
        try {
          const resp = await fetch('/progress');
          const data = await resp.json();
          if (data.progress) {
            progressText.textContent = data.progress;
          }
        } catch (err) {
          console.error('Progress polling error:', err);
        }
      }, 200); // Poll every 200ms

      // Submit via AJAX
      try {
        const formData = new FormData();
        formData.append('image', file);

        const response = await fetch('/analyze', {
          method: 'POST',
          body: formData
        });

        // IMPORTANT: Stop polling immediately when response received
        if (progressInterval) {
          clearInterval(progressInterval);
          progressInterval = null;
        }
        progressText.textContent = '';

        if (!response.ok) {
          throw new Error('Analysis failed');
        }

        const result = await response.json();

        // Hide loading overlay
        loadingOverlay.classList.remove('active');
        inlineSpinner.classList.remove('active');
        analyzeBtn.disabled = false;

        // Display results on the page
        displayResults(result);
        
        // Show success toast if analysis completed
        if (result.status === 'ok') {
          showToast('success', 'Analysis Complete', `Wound classified as: ${result.pred_label} with ${result.confidence_pct}% confidence.`);
        }

      } catch (error) {
        // Make sure to stop polling on error too
        if (progressInterval) {
          clearInterval(progressInterval);
          progressInterval = null;
        }
        progressText.textContent = '';
        loadingOverlay.classList.remove('active');
        inlineSpinner.classList.remove('active');
        analyzeBtn.disabled = false;
        showToast('error', 'Analysis Failed', 'An error occurred during image analysis. Please try again.');
      }
    });

    // Function to display results dynamically
    function displayResults(result) {
      const resultBox = document.getElementById('result-box');
      const geminiBox = document.getElementById('gemini-box');

      if (result.status === 'error') {
        resultBox.innerHTML = `
          <div class="err">Model Load Error</div>
          <pre>${result.message}</pre>
          <p class="muted">Re-export your Keras model with input=(224,224,3).</p>
        `;
      } else if (result.status === 'not_wound') {
        resultBox.innerHTML = `
          <div class="err">Bukan Gambar Luka</div>
          <p class="muted">Gemini triage indicates the uploaded image is not a wound/ulcer.</p>
          ${result.input_image ? `
            <div class="viz-container">
              <div class="viz-box">
                <img src="/${result.input_image}" alt="uploaded">
              </div>
            </div>
          ` : ''}
        `;
      } else if (result.status === 'ok') {
        // Update result box
        resultBox.innerHTML = `
          <div class="ok">Prediction completed</div>
          <p>
            <span class="label">Predicted Class:</span>
            <span class="pill">${result.pred_label}</span>
          </p>
          <p>
            <span class="label">Confidence Score:</span> ${result.confidence_pct}%
          </p>
          <div class="confidence-bar">
            <div class="confidence-fill" style="width: ${result.confidence_pct}%;"></div>
          </div>

          <div class="viz-container">
            <div class="viz-box" id="gradcam-box">
              <img src="/${result.heatmap_image}" alt="heatmap">
            </div>
            <div class="viz-box" id="overlay-box">
              <img src="/${result.overlay_image}" alt="overlay">
            </div>
          </div>
        `;

        // Update Gemini box - properly handle the content container
        const geminiContent = geminiBox.querySelector('.gemini-content');
        if (geminiContent) {
          // Remove any inline styles that might be affecting layout
          geminiContent.removeAttribute('style');
          geminiContent.innerHTML = result.gemini_html;
        }
      }

      // Scroll to results
      resultBox.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    async function runTriage(file) {
      // Run fast LLM triage via AJAX; set uploadForm.dataset.triage = 'true'|'false'
      inlineSpinner.classList.add('active');
      try {
        const fd = new FormData();
        fd.append('image', file, file.name);
        const resp = await fetch('/triage', { method: 'POST', body: fd });
        if (!resp.ok) {
          console.warn('Triage request failed', resp.status);
          uploadForm.dataset.triage = 'true';
          return;
        }
        const j = await resp.json();
        uploadForm.dataset.triage = j.is_wound ? 'true' : 'false';
        uploadForm.dataset.triage_msg = j.message || '';
        if (!j.is_wound) {
          // Show a quick user-facing message and keep preview
          showToast('warning', 'Image Verification Failed', j.message || 'The uploaded image does not appear to be a wound. Please upload a clear wound image.');
          analyzeBtn.disabled = true;
        } else {
          analyzeBtn.disabled = false;
        }
      } catch (err) {
        console.error('Triage error', err);
        // On error, be permissive and allow processing to continue server-side
        uploadForm.dataset.triage = 'true';
        analyzeBtn.disabled = false;
      } finally {
        inlineSpinner.classList.remove('active');
      }
    }

    // 8. Hide loading overlay if user comes back (e.g., form error)
    window.addEventListener('pageshow', function(event) {
      if (event.persisted || performance.getEntriesByType("navigation")[0].type === "back_forward") {
        loadingOverlay.classList.remove('active');
        inlineSpinner.classList.remove('active');
        analyzeBtn.disabled = false;
      }
    });

    // 9. Keep preview image after page reload (if result exists)
    {% if result and result.input_image %}
    window.addEventListener('DOMContentLoaded', function() {
      // If we have a result, show the uploaded image in preview
      const uploadedImage = "{{ '/' + result.input_image }}";
      previewImg.src = uploadedImage;
      previewImg.style.display = 'block';
      previewPlaceholder.style.display = 'none';
      fileNameDisplay.textContent = 'Analyzed image';
      fileNameDisplay.style.display = 'inline';
      clearFile.style.display = 'inline';
    });
    {% endif %}

    // 10. Image zoom functionality for gradcam and overlay images
    const zoomBackdrop = document.getElementById('zoomBackdrop');

    // Add click listeners to all viz-box elements
    document.addEventListener('click', function(e) {
      const vizBox = e.target.closest('.viz-box');

      if (vizBox) {
        // Check if clicking on a viz-box with an image
        const img = vizBox.querySelector('img');
        if (img && img.src) {
          // Toggle zoom
          if (vizBox.classList.contains('zoomed')) {
            // Zoom out
            vizBox.classList.remove('zoomed');
            zoomBackdrop.classList.remove('active');
            document.body.style.overflow = '';
          } else {
            // Close any other zoomed images first
            document.querySelectorAll('.viz-box.zoomed').forEach(box => {
              box.classList.remove('zoomed');
            });
            // Zoom in
            vizBox.classList.add('zoomed');
            zoomBackdrop.classList.add('active');
            document.body.style.overflow = 'hidden';
          }
        }
      } else if (e.target === zoomBackdrop) {
        // Click on backdrop closes zoom
        document.querySelectorAll('.viz-box.zoomed').forEach(box => {
          box.classList.remove('zoomed');
        });
        zoomBackdrop.classList.remove('active');
        document.body.style.overflow = '';
      }
    });

    // --- Welcome Modal Functionality ---
    const welcomeModal = document.getElementById('welcomeModal');
    const closeModalBtn = document.getElementById('closeModalBtn');
    const WELCOME_MODAL_KEY = 'woundai_welcome_shown';

    // Function to close modal and mark as shown
    function closeWelcomeModal() {
      welcomeModal.classList.remove('active');
      document.body.style.overflow = ''; // Restore scrolling
      // Mark that user has seen the welcome modal
      localStorage.setItem(WELCOME_MODAL_KEY, 'true');
    }

    // Show modal when page loads (only for new users)
    window.addEventListener('DOMContentLoaded', function() {
      // Check if user has seen the modal before
      const hasSeenWelcome = localStorage.getItem(WELCOME_MODAL_KEY);

      if (!hasSeenWelcome) {
        // New user - show the modal with a slight delay for better UX
        setTimeout(function() {
          welcomeModal.classList.add('active');
          document.body.style.overflow = 'hidden'; // Prevent background scrolling
        }, 300);
      }
    });

    // Close modal when clicking the close button
    closeModalBtn.addEventListener('click', function() {
      closeWelcomeModal();
    });

    // Close modal when clicking outside the modal content
    welcomeModal.addEventListener('click', function(e) {
      if (e.target === welcomeModal) {
        closeWelcomeModal();
      }
    });

    // ESC key to close both zoom and modal
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        // Close welcome modal if active
        if (welcomeModal.classList.contains('active')) {
          closeWelcomeModal();
        }
        // Close zoomed images
        document.querySelectorAll('.viz-box.zoomed').forEach(box => {
          box.classList.remove('zoomed');
        });
        zoomBackdrop.classList.remove('active');
        document.body.style.overflow = '';
      }
    });
  </script>
</body>
</html>